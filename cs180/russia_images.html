<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Colorizing Images of the Russian Empire</title>
  <link rel="stylesheet" href="russia_images.css">
</head>
<body>

  <div class="content-container">
    <h1>Colorizing Images of the Russian Empire</h1>
    <p class="center_p">Andrew Goldberg</p>

    <h2>Project Overview</h2>
    <div class="image-row">
      <div class="image-col">
        <figure>
          <img src="media/proj1/color_adjusted/emir.jpg" alt="Emir - Color Adjusted" loading="lazy" class="feature-image">
        </figure>
      </div>
      <div class="image-col">
        <figure>
          <img src="media/proj1/color_adjusted/bonus-train.jpg" alt="Combined Church Features" loading="lazy" class="feature-image">
        </figure>
      </div>
      <div class="image-col">
        <figure>
          <img src="media/proj1/color_adjusted/melons.jpg" alt="Melons - Color Adjusted" loading="lazy" class="feature-image">
        </figure>
      </div>
    </div>
    <a href="https://en.wikipedia.org/wiki/Sergey_Prokudin-Gorsky">Sergei Mikhailovich Prokudin-Gorskii</a> traveled across Russia in the early 1900s capturing color photographs onto glass plates using glass filters. His glass plates were purchased by the <a href="https://www.loc.gov/collections/prokudin-gorskii/?st=grid">Library of Congress</a> and they digitized them offering the three color channel images in black and white which can be realigned to reconstruct the images in color.

    <h2>Sobel Edge Detection Channel Alignment</h2>
    <p>
      Aligning the color channels directly is difficult because their intensities are scaled differently and change differently across the image. Because of this, I chose to use edges as my alignment features because they are generally more consistent across image channels.
    </p>
    <p>
      I perfom vertical and horizontal edge detection using <a href="https://en.wikipedia.org/wiki/Sobel_operator">Sobel edge detection</a> then combined the two channels by taking the L2 norm of the vertical and horizontal values on each pixel. This makes all of the values positive, in one channel, and at the same reoslution as the original image (by padding the convolution). I implemented my own conv2d operator using np.lib.stride_tricks.sliding_window_view. I convert my edge feature map to a boolean mask by keeping only edges greater than the 90th percentile edge. I found that this didn't have a significant impact on the output of my algorithm, but working with a boolean mask made other operations, particularly np.roll, faster (~2x overall runtime) than working with floats since the array is shifted so many times.
    </p>

    <p>
      To align align the images I start by shrinking them by the largest power of 2 such that they're still larger than 256x256. Then, I compute the edge detection image features. I iterate over a 40 by 40 search window centered at the origin, shifting the blue and green features then checking their alignment with the red channel's features. I compare alignments by taking the normalized dot product and taking the shift which yields the highest value.
      Then, I move up to double the resolution and repeat the process with the search window centered based on the previous iterations offset (adjusted to the new scale). I crop the images to be at most 700 by 700 and always crop at least 5% on each side to remove the impact of the borders.
    </p>

  <div class="image-row">
    <div class="image-col">
      <figure>
        <img src="media/proj1/image_features/optimized/church_feat_combined_opt.jpg" alt="Church Combined Features" loading="lazy" class="feature-image">
        <figcaption>Combined Church Features</figcaption>
      </figure>
    </div>
  </div>

  </div>


  <!-- Full-width image features section -->
  <div class="full-width-section">

    <div class="image-row">
      <div class="image-col">
        <figure>
          <img src="media/proj1/image_features/optimized/church_feat_r_opt.jpg" alt="Church Red Features" loading="lazy" class="feature-image">
          <figcaption>Red Channel Features</figcaption>
        </figure>
      </div>
      <div class="image-col">
        <figure>
          <img src="media/proj1/image_features/optimized/church_feat_g_opt.jpg" alt="Church Green Features" loading="lazy" class="feature-image">
          <figcaption>Green Channel Features</figcaption>
        </figure>
      </div>
      <div class="image-col">
        <figure>
          <img src="media/proj1/image_features/optimized/church_feat_b_opt.jpg" alt="Church Blue Features" loading="lazy" class="feature-image">
          <figcaption>Blue Channel Features</figcaption>
        </figure>
      </div>
    </div>

    <div class="image-row">
      <div class="image-col">
        <figure>
          <img src="media/proj1/color_adjusted/icon.jpg" alt="Icon Features" loading="lazy" class="feature-image">
          <figcaption>Icon Image</figcaption>
        </figure>
      </div>
      <div class="image-col">
        <figure>
          <img src="media/proj1/image_features/icon_feats.jpg" alt="Icon Features" loading="lazy" class="feature-image">
          <figcaption>Icon Features</figcaption>
        </figure>
      </div>
    </div>
    <figcaption>
      Here is a visualization of the image features computed on a full aligned image.
    </figcaption>
  </div>

  <div class="content-container">
    <h2>Color Correction</h2>
    <p>These photos were taken using red, green, and blue filters and we've assumed that each filter corresponds exactly to a single RGB channel in our reconstructed image. But, these filters were likely imperfect and overlapping in sensitivity (ex: the red intensity is also impacted by green light). Also, our choices of wavelength distributions for rgb likely changed going from glass panels to jpg. As a result, we can get more accurate color if we model each filter's response as contributing to all three RGB channels rather than one.</p>

    <p>I used <a href="https://viser.studio/main/">Viser</a> to create a tool where I could adjust the projections of the color channels and find a solution which qualitatively looks good.</p>

    <div class="image-row">
      <div class="image-col">
        <figure>
          <img src="media/proj1/viser_ui.png">
        </figure>
        <figcaption>My Viser UI where the projection for each channel can be modified to preview adjusted images with the originals.</figcaption>
      </div>
    </div>

    <p>I found this mapping gave improved colors:</p>
      <p>R -> [245, 34, 0]</p>
      <p>G -> [10, 139, 0]</p>
      <p>B -> [0, 81, 255]</p>

    <p>Physically, this corresponds to some green light being allowed through the red and blue filters and contributing to the intensities in those channels. Green is between red and blue in the visible light spectrum so it's not surprising there might be some bleeding between the filters.</p>

    <p>Below are images comparing the overlayed images before and after color correction. The impact of this change varies between photos and it doesn't fix other issues like exposure, but overall it gives (in my view) generally more realistic colors often removing green and purple tints on the images.</p>
  </div>

  
  <div class="color-correction-grid">
    <!-- Column headers - only visible on wide screens -->
    <div class="column-headers">
      <div class="header-cell">No Correction (left)</div>
      <div class="header-cell">Color Correction (right)</div>
    </div>

    <div class="image-pair">
      <div class="image-figures">
        <figure>
          <figcaption>No Correction</figcaption>
          <img src="media/proj1/overlayed/lastochikino.jpg" alt="Lastochikino - No Correction">
        </figure>
        <figure>
          <figcaption>Color Correction</figcaption>
          <img src="media/proj1/color_adjusted/lastochikino.jpg" alt="Lastochikino - Color Adjusted">
        </figure>
      </div>
      <div class="image-metadata">lastochikino rb: [-75, 8] rg: [-78, 6] time: 28s</div>
    </div>

    <div class="image-pair">
      <div class="image-figures">
        <figure>
          <figcaption>No Correction</figcaption>
          <img src="media/proj1/overlayed/harvesters.jpg" alt="Harvesters - No Correction">
        </figure>
        <figure>
          <figcaption>Color Correction</figcaption>
          <img src="media/proj1/color_adjusted/harvesters.jpg" alt="Harvesters - Color Adjusted">
        </figure>
      </div>
      <div class="image-metadata">harvesters rb: [-123, -14] rg: [-64, 3] time: 24s</div>
    </div>

    <div class="image-pair">
      <div class="image-figures">
        <figure>
          <img src="media/proj1/overlayed/icon.jpg" alt="Icon - No Correction">
        </figure>
        <figure>
          <img src="media/proj1/color_adjusted/icon.jpg" alt="Icon - Color Adjusted">
        </figure>
      </div>
      <div class="image-metadata">icon rb: [-90, -23] rg: [-49, -5] time: 25s</div>
    </div>

    <div class="image-pair">
      <div class="image-figures">
        <figure>
          <img src="media/proj1/overlayed/church.jpg" alt="Church - No Correction">
        </figure>
        <figure>
          <img src="media/proj1/color_adjusted/church.jpg" alt="Church - Color Adjusted">
        </figure>
      </div>
      <div class="image-metadata">church rb: [-58, 4] rg: [-33, 8] time: 26s</div>
    </div>

  <div class="image-pair">
    <div class="image-figures">
      <figure>
        <img src="media/proj1/overlayed/bonus-forest.jpg" alt="Forest - No Correction">
      </figure>
      <figure>
        <img src="media/proj1/color_adjusted/bonus-forest.jpg" alt="Forest - Color Adjusted">
      </figure>
    </div>
    <div class="image-metadata">forest rb: [-97, -8] rg: [-59, -35] time: 25s</div>
    </div>

    <div class="image-pair">
      <div class="image-figures">
        <figure>
          <img src="media/proj1/overlayed/bonus-train.jpg" alt="Bonus Train - No Correction">
        </figure>
        <figure>
          <img src="media/proj1/color_adjusted/bonus-train.jpg" alt="Bonus Train - Color Adjusted">
        </figure>
      </div>
      <div class="image-metadata">train* rb: [-292, -168] rg: [-254, 199] time: 28s</div>
    </div>

    <div class="image-pair">
      <div class="image-figures">
        <figure>
          <img src="media/proj1/overlayed/bonus-bridge.jpg" alt="Bonus Bridge - No Correction">
        </figure>
        <figure>
          <img src="media/proj1/color_adjusted/bonus-bridge.jpg" alt="Bonus Bridge - Color Adjusted">
        </figure>
      </div>
      <div class="image-metadata">bridge rb: [-117, 28] rg: [-54, 15] time: 39s</div>
    </div>

    <div class="image-pair">
      <div class="image-figures">
        <figure>
          <img src="media/proj1/overlayed/bonus-greenhouse.jpg" alt="Bonus Greenhouse - No Correction">
        </figure>
        <figure>
          <img src="media/proj1/color_adjusted/bonus-greenhouse.jpg" alt="Bonus Greenhouse - Color Adjusted">
        </figure>
      </div>
      <div class="image-metadata">greenhouse rb: [-126, -33] rg: [-66, -6] time: 28s</div>
    </div>

    <div class="image-pair">
      <div class="image-figures">
        <figure>
          <img src="media/proj1/overlayed/cathedral.jpg" alt="Cathedral - No Correction">
        </figure>
        <figure>
          <img src="media/proj1/color_adjusted/cathedral.jpg" alt="Cathedral - Color Adjusted">
        </figure>
      </div>
      <div class="image-metadata">cathedral rb: [-12, -3] rg: [-7, -1] time: 1s</div>
    </div>

    <div class="image-pair">
      <div class="image-figures">
        <figure>
          <img src="media/proj1/overlayed/emir.jpg" alt="Emir - No Correction">
        </figure>
        <figure>
          <img src="media/proj1/color_adjusted/emir.jpg" alt="Emir - Color Adjusted">
        </figure>
      </div>
      <div class="image-metadata">emir rb: [-107, -41] rg: [-57, -17] time: 24s</div>
    </div>


    <div class="image-pair">
      <div class="image-figures">
        <figure>
          <img src="media/proj1/overlayed/italil.jpg" alt="Italil - No Correction">
        </figure>
        <figure>
          <img src="media/proj1/color_adjusted/italil.jpg" alt="Italil - Color Adjusted">
        </figure>
      </div>
      <div class="image-metadata">italil rb: [-76, -36] rg: [-39, -15] time: 26s</div>
    </div>

    <div class="image-pair">
      <div class="image-figures">
        <figure>
          <img src="media/proj1/overlayed/lugano.jpg" alt="Lugano - No Correction">
        </figure>
        <figure>
          <img src="media/proj1/color_adjusted/lugano.jpg" alt="Lugano - Color Adjusted">
        </figure>
      </div>
      <div class="image-metadata">lugano rb: [-92, 28] rg: [-52, 13] time: 26s</div>
    </div>

    <div class="image-pair">
      <div class="image-figures">
        <figure>
          <img src="media/proj1/overlayed/melons.jpg" alt="Melons - No Correction">
        </figure>
        <figure>
          <img src="media/proj1/color_adjusted/melons.jpg" alt="Melons - Color Adjusted">
        </figure>
      </div>
      <div class="image-metadata">melons rb: [-181, -13] rg: [-96, -3] time: 34s</div>
    </div>

    <div class="image-pair">
      <div class="image-figures">
        <figure>
          <img src="media/proj1/overlayed/monastery.jpg" alt="Monastery - No Correction">
        </figure>
        <figure>
          <img src="media/proj1/color_adjusted/monastery.jpg" alt="Monastery - Color Adjusted">
        </figure>
      </div>
      <div class="image-metadata">monastery rb: [-3, -2] rg: [-6, -1] time: 3s</div>
    </div>

    <div class="image-pair">
      <div class="image-figures">
        <figure>
          <img src="media/proj1/overlayed/self_portrait.jpg" alt="Self Portrait - No Correction">
        </figure>
        <figure>
          <img src="media/proj1/color_adjusted/self_portrait.jpg" alt="Self Portrait - Color Adjusted">
        </figure>
      </div>
      <div class="image-metadata">self portrait rb: [-175, -37] rg: [-98, -8] time: 40s</div>
    </div>

    <div class="image-pair">
      <div class="image-figures">
        <figure>
          <img src="media/proj1/overlayed/siren.jpg" alt="Siren - No Correction">
        </figure>
        <figure>
          <img src="media/proj1/color_adjusted/siren.jpg" alt="Siren - Color Adjusted">
        </figure>
      </div>
      <div class="image-metadata">siren rb: [-96, 23] rg: [-47, 19] time: 38s</div>
    </div>

    <div class="image-pair">
      <div class="image-figures">
        <figure>
          <img src="media/proj1/overlayed/three_generations.jpg" alt="Three Generations - No Correction">
        </figure>
        <figure>
          <img src="media/proj1/color_adjusted/three_generations.jpg" alt="Three Generations - Color Adjusted">
        </figure>
      </div>
      <div class="image-metadata">three generations rb: [-110, -12] rg: [-59, 4] time: 25s</div>
    </div>

    <div class="image-pair">
      <div class="image-figures">
        <figure>
          <img src="media/proj1/overlayed/tobolsk.jpg" alt="Tobolsk - No Correction">
        </figure>
        <figure>
          <img src="media/proj1/color_adjusted/tobolsk.jpg" alt="Tobolsk - Color Adjusted">
        </figure>
      </div>
      <div class="image-metadata">tobolsk rb: [-6, -3] rg: [-4, 0] time: 1s</div>
    </div>
  </div>

  <div class="content-container">
    <p class="acknowledge">*The train image required a larger offset than the other images, so I changed a hyperparameter for that image generation. I needed to start from a more scaled down image to expand my search window. </p>
    <p class="acknowledge">The train, forest, bridge, and greenhouse are all additional images I chose to show.</p>
    <p class="acknowledge">I used ChatGPT while building this website.</p>
  </div>

  <script>
    // Handle feature image loading states
    document.addEventListener('DOMContentLoaded', function() {
      const featureImages = document.querySelectorAll('.feature-image');
      
      featureImages.forEach(img => {
        img.addEventListener('load', function() {
          this.classList.add('loaded');
        });
        
        // If image is already loaded (cached), add loaded class immediately
        if (img.complete && img.naturalHeight !== 0) {
          img.classList.add('loaded');
        }
      });
    });
  </script>
</body>
</html>